#!/usr/bin/python

from sys import argv, exit
from time import sleep
from log import *

from ConfigParser import RawConfigParser

from subprocess import Popen, PIPE
from shlex import split

#print "Updating ..."
#Popen(['git','pull']).wait()

config = RawConfigParser()
configfile = "/etc/gst-phone.conf"
try:
	config.read(configfile)
except:
	print "Warning: "+configfile+" not found."
	exit()

v4l2_ctl		= config.get('settings', 'v4l2-ctl')
gst_inspect	= config.get('settings', 'gst-inspect')
gst_launch	= config.get('settings', 'gst-launch')
retries		= int(config.get('settings', 'default_retries'))

# testing for Raspberry Pi OpenMAX libraries
if 'omxh264dec' in Popen(split(gst_inspect), stdout=PIPE).communicate()[0]:
	log("Good: gstreamer has OpenMAX superpowers!")
else:
	log("Warning: gstreamer does not appear to have OpenMAX powers.")

# webcam present ?
d = Popen(split(v4l2_ctl+' --list-devices'), stdout=PIPE, stderr=PIPE).communicate()[0].strip()
if len(d) > 0 and not 'Failed' in d:
	print d
else:
	log("No webcam ?")

if len(argv) > 1:		# client mode
	from client import *
	address = argv[1]
	if retries < 0:
		log("Retrying until calling succeeds. Press Ctrl+C to quit ...")
		while not call(address):
			# retry
			True
	else:
		for i in range(retries+1):
			call(address)

else:				# server mode
	log("Noone to call. Waiting for incoming call. Press Ctrl+C to quit ...")
	from server import *
	s = Server()
	s.listen()
